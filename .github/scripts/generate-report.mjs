#!/usr/bin/env node
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ghost Void Engine â€” Validation Report Generator
//
// Aggregates all validation results into a markdown report that
// gets posted as a PR comment and saved as an artifact.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import { readFileSync, writeFileSync, existsSync, readdirSync } from "fs";
import { join } from "path";

const ENGINE_TESTS = process.env.ENGINE_TESTS || "unknown";
const INTEGRATION_TESTS = process.env.INTEGRATION_TESTS || "unknown";
const CODE_QUALITY = process.env.CODE_QUALITY || "unknown";
const DETERMINISM = process.env.DETERMINISM || "unknown";

function statusIcon(status) {
  switch (status) {
    case "success":
      return "âœ…";
    case "failure":
      return "âŒ";
    case "skipped":
      return "â­ï¸";
    case "cancelled":
      return "ğŸš«";
    default:
      return "â“";
  }
}

function overallStatus(statuses) {
  if (statuses.includes("failure")) return "FAILED";
  if (statuses.every((s) => s === "success")) return "PASSED";
  if (statuses.includes("skipped")) return "PARTIAL";
  return "UNKNOWN";
}

// â”€â”€â”€ Build Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const statuses = [ENGINE_TESTS, INTEGRATION_TESTS, CODE_QUALITY, DETERMINISM];
const overall = overallStatus(statuses);
const overallIcon = overall === "PASSED" ? "âœ…" : overall === "FAILED" ? "âŒ" : "âš ï¸";

const timestamp = new Date().toISOString();

let report = `# ${overallIcon} Game Validation Report

> **Status**: ${overall}
> **Generated**: ${timestamp}
> **Commit**: \`$\{process.env.GITHUB_SHA?.slice(0, 8) || "local"}\`

---

## Pipeline Results

| Stage | Status | Result |
|-------|--------|--------|
| ğŸ§ª Engine Tests | ${statusIcon(ENGINE_TESTS)} | ${ENGINE_TESTS} |
| ğŸ”— Integration Tests | ${statusIcon(INTEGRATION_TESTS)} | ${INTEGRATION_TESTS} |
| ğŸ” Code Quality | ${statusIcon(CODE_QUALITY)} | ${CODE_QUALITY} |
| ğŸ” Determinism Check | ${statusIcon(DETERMINISM)} | ${DETERMINISM} |

---

## Test Log Excerpts

`;

// Collect logs from artifacts directory
const artifactsDir = "artifacts";
if (existsSync(artifactsDir)) {
  const dirs = readdirSync(artifactsDir, { withFileTypes: true }).filter((d) => d.isDirectory());

  for (const dir of dirs) {
    const dirPath = join(artifactsDir, dir.name);
    const files = readdirSync(dirPath).filter((f) => f.endsWith(".log"));

    for (const file of files) {
      const content = readFileSync(join(dirPath, file), "utf8");
      const lines = content.split("\n");
      const excerpt = lines.slice(-20).join("\n"); // last 20 lines

      report += `### ğŸ“„ ${file}\n\n`;
      report += "```\n";
      report += excerpt;
      report += "\n```\n\n";
    }
  }
} else {
  report += "*No artifact logs found.*\n\n";
}

// Recommendations
report += `---

## Recommendations

`;

if (ENGINE_TESTS === "failure") {
  report += `- âŒ **Engine tests failed** â€” check C++ compilation and assertion logic\n`;
}
if (INTEGRATION_TESTS === "failure") {
  report += `- âŒ **Integration tests failed** â€” verify engine binary and server compatibility\n`;
}
if (CODE_QUALITY === "failure") {
  report += `- âŒ **Code quality issues** â€” run \`cppcheck\` locally to see warnings\n`;
}
if (DETERMINISM === "failure") {
  report += `- âŒ **Determinism broken** â€” hash chain or synthesis is non-reproducible\n`;
}
if (overall === "PASSED") {
  report += `- âœ… All validation checks passed â€” this build is ready for merge\n`;
}

report += `
---

*Generated by the ğŸ® Game Validation Agent*
`;

writeFileSync("validation-report.md", report);
console.log(`ğŸ“Š Report written to validation-report.md (${report.length} bytes)`);
console.log(`Overall: ${overallIcon} ${overall}`);
