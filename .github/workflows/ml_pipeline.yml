name: ML Pipeline

# Trigger the workflow on pushes to main, pull requests and nightly schedule.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      # ECR repository URI and S3 bucket name should be stored in repository secrets.
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Data validation
        run: |
          echo "Running data validation..."
          # Replace with actual validation script
          if [ -f scripts/validate_data.py ]; then python scripts/validate_data.py --bucket $S3_BUCKET; fi

      - name: Train model
        run: |
          echo "Training model..."
          # Replace with actual training script
          if [ -f scripts/train_model.py ]; then python scripts/train_model.py --bucket $S3_BUCKET; fi

      - name: Run tests
        env:
          PYTHONPATH: .
        run: |
          echo "Running unit tests..."
          if [ -d tests ]; then pytest -q tests; fi

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Docker image..."
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          echo "Pushing Docker image to ECR..."
          docker push $ECR_REPOSITORY:$IMAGE_TAG

      - name: Configure AWS credentials for kubectl
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.DEPLOY_ROLE_ARN }}

      - name: Update Kubernetes deployment
        run: |
          echo "Updating Kubernetes deployment..."
          # Use kubeconfig pointing to your EKS cluster
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region $AWS_REGION
          kubectl set image deployment/ml-service ml-container=$ECR_REPOSITORY:${{ github.sha }}
          kubectl rollout status deployment/ml-service

      - name: Notify success
        if: success()
        run: echo "ML pipeline completed successfully."
