name: Multimodal RAG CI/CD

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Prompt used to build multimodal RAG workflow bundle"
        required: false
        default: "Infrastructure avatar worldline build for multimodal MCP orchestration"
        type: string
      cluster_count:
        description: "Number of artifact clusters for LoRA attention weights"
        required: false
        default: "4"
        type: string
      top_k:
        description: "Top K tokens to reconstruct per logic-tree node"
        required: false
        default: "3"
        type: string
  push:
    branches: [main]
    paths:
      - "orchestrator/multimodal_worldline.py"
      - "orchestrator/multimodal_rag_workflow.py"
      - "scripts/build_multimodal_rag_bundle.py"
      - "scripts/knowledge_ingestion.py"
      - "orchestrator/webhook.py"
      - "tests/test_multimodal_worldline.py"
      - "tests/test_multimodal_rag_workflow.py"
      - "tests/test_worldline_ingestion.py"
      - "tests/test_mcp_agents.py"
      - "tests/test_stateflow.py"
      - ".github/workflows/multimodal-rag-cicd.yml"
  pull_request:
    branches: [main]
    paths:
      - "orchestrator/multimodal_worldline.py"
      - "orchestrator/multimodal_rag_workflow.py"
      - "scripts/build_multimodal_rag_bundle.py"
      - "scripts/knowledge_ingestion.py"
      - "orchestrator/webhook.py"
      - "tests/test_multimodal_worldline.py"
      - "tests/test_multimodal_rag_workflow.py"
      - "tests/test_worldline_ingestion.py"
      - "tests/test_mcp_agents.py"
      - "tests/test_stateflow.py"
      - ".github/workflows/multimodal-rag-cicd.yml"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run webhook and trigger validation suites
        run: |
          pytest -q \
            tests/test_stateflow.py \
            tests/test_mcp_agents.py \
            tests/test_worldline_ingestion.py

      - name: Run multimodal RAG logic-tree suites
        run: |
          pytest -q \
            tests/test_multimodal_worldline.py \
            tests/test_multimodal_rag_workflow.py \
            tests/test_rag_pipeline.py

  build-rag-bundle:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build multimodal RAG workflow bundle
        env:
          INPUT_PROMPT: ${{ github.event.inputs.prompt }}
          INPUT_CLUSTER_COUNT: ${{ github.event.inputs.cluster_count }}
          INPUT_TOP_K: ${{ github.event.inputs.top_k }}
        run: |
          PROMPT="${INPUT_PROMPT:-Infrastructure avatar worldline build for multimodal MCP orchestration}"
          CLUSTER_COUNT="${INPUT_CLUSTER_COUNT:-4}"
          TOP_K="${INPUT_TOP_K:-3}"
          python scripts/build_multimodal_rag_bundle.py \
            --prompt "$PROMPT" \
            --repository "${GITHUB_REPOSITORY}" \
            --commit-sha "${GITHUB_SHA}" \
            --actor "${GITHUB_ACTOR}" \
            --cluster-count "${CLUSTER_COUNT}" \
            --top-k "${TOP_K}" \
            --output-dir build/multimodal_rag \
            --strict

      - name: Upload multimodal RAG artifacts
        uses: actions/upload-artifact@v4
        with:
          name: multimodal-rag-bundle-${{ github.run_number }}
          path: build/multimodal_rag

