name: "Agentic Ingestion & LoRA Synthesis"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ingest-and-embed:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC handshake
      contents: read
      issues: write

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud (WIF Handshake)"
        id: auth
        uses: google-github-actions/auth@v2
        with:
          # Defined in your Terraform/Setup script
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: 'id_token'
          id_token_audience: ${{ secrets.MCP_SERVER_AUDIENCE }}

      - name: "Generate Repository Snapshot"
        run: |
          # Collect artifacts for tensor processing
          python -c "
          import os, json
          snapshot = {
              'repository': os.getenv('GITHUB_REPOSITORY'),
              'commit_sha': os.getenv('GITHUB_SHA'),
              'code_snippets': [],
              'readme_content': open('README.md').read() if os.path.exists('README.md') else ''
          }
          for root, dirs, files in os.walk('app'):
              for file in files:
                  if file.endswith('.py'):
                      path = os.path.join(root, file)
                      snapshot['code_snippets'].append({
                          'file_path': path,
                          'content': open(path).read()
                      })
          with open('payload.json', 'w') as f:
              json.dump(snapshot, f)
          "

      - name: "Push to Knowledge-Store Agent (RAG Tooling)"
        run: |
          # The A2A handshake verification happens at this endpoint
          curl -X POST "${{ secrets.MCP_INGEST_ENDPOINT }}/ingest" \
            -H "Authorization: Bearer ${{ steps.auth.outputs.id_token }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            -o response.json
          
          echo "INGESTION_STATUS=$(jq -r .status response.json)" >> $GITHUB_ENV

      - name: "Post Ingestion Receipt"
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = process.env.INGESTION_STATUS === 'success' ? '‚úÖ' : '‚ùå';
            const issue_number = context.payload.pull_request
              ? context.payload.pull_request.number
              : context.payload.issue
                ? context.payload.issue.number
                : null;

            if (!issue_number) {
              core.info('No issue/PR context available; skipping ingestion receipt comment.');
              return;
            }

            await github.rest.issues.createComment({
              issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### üõ°Ô∏è A2A Ingestion Status: ${status}\nRepository knowledge has been indexed as multimodal tensors for the Avatar RAG.`
            });
