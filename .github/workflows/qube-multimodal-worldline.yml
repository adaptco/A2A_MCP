name: Qube Multimodal Worldline

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Prompt to orchestrate text->image->video->multimodal worldline"
        required: true
        type: string
      cluster_count:
        description: "Number of artifact clusters for LoRA attention weights"
        required: false
        default: "4"
        type: string
  push:
    branches: [main]
    paths:
      - "orchestrator/multimodal_worldline.py"
      - "orchestrator/end_to_end_orchestration.py"
      - "scripts/build_worldline_block.py"
      - "scripts/run_end_to_end_orchestration.py"
      - ".github/workflows/qube-multimodal-worldline.yml"

jobs:
  run-end-to-end-worldline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Execute end-to-end orchestration
        env:
          INPUT_PROMPT: ${{ github.event.inputs.prompt }}
          INPUT_CLUSTER_COUNT: ${{ github.event.inputs.cluster_count }}
          GITHUB_MCP_API_URL: ${{ secrets.GITHUB_MCP_API_URL }}
        run: |
          PROMPT="${INPUT_PROMPT:-Infrastructure avatar worldline build for multimodal MCP orchestration}"
          CLUSTER_COUNT="${INPUT_CLUSTER_COUNT:-4}"
          ARGS=()
          if [ -n "${GITHUB_MCP_API_URL}" ]; then
            ARGS+=(--mcp-api-url "${GITHUB_MCP_API_URL}")
          fi
          python scripts/run_end_to_end_orchestration.py \
            --prompt "$PROMPT" \
            --repository "${GITHUB_REPOSITORY}" \
            --commit-sha "${GITHUB_SHA}" \
            --actor "${GITHUB_ACTOR}" \
            --cluster-count "${CLUSTER_COUNT}" \
            --authorization "Bearer ${GITHUB_TOKEN}" \
            --output-block worldline_block.json \
            --output-result orchestration_result.json \
            "${ARGS[@]}"
          cat orchestration_result.json

      - name: Upload orchestration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worldline-orchestration-${{ github.run_number }}
          path: |
            worldline_block.json
            orchestration_result.json
