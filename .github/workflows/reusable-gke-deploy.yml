name: Reusable GKE Deploy

on:
  workflow_call:
    inputs:
      environment_name:
        description: Target environment name
        required: true
        type: string
      namespace:
        description: Kubernetes namespace
        required: true
        type: string
      values_file:
        description: Environment-specific values file path
        required: true
        type: string
      mcp_image_repository:
        description: MCP image repository
        required: true
        type: string
      mcp_image_tag:
        description: MCP image tag
        required: true
        type: string
      orchestrator_image_repository:
        description: Orchestrator image repository
        required: true
        type: string
      orchestrator_image_tag:
        description: Orchestrator image tag
        required: true
        type: string
      smoke_enabled:
        description: Run smoke tests after deployment
        required: false
        default: true
        type: boolean
      rollback_on_smoke_fail:
        description: Attempt rollback when smoke fails
        required: false
        default: false
        type: boolean
      release_name:
        description: Helm release name
        required: false
        default: a2a-mcp
        type: string
    secrets:
      GCP_WIF_PROVIDER:
        required: true
      GCP_SERVICE_ACCOUNT:
        required: true
      GKE_CLUSTER:
        required: true
      GKE_LOCATION:
        required: true
      GCP_PROJECT_ID:
        required: true
      MCP_BASE_URL:
        required: false
      ORCHESTRATOR_BASE_URL:
        required: false
      MCP_TOKEN:
        required: false
    outputs:
      helm_revision_before:
        description: Helm revision before deployment
        value: ${{ jobs.report.outputs.helm_revision_before }}
      helm_revision_after:
        description: Helm revision after deployment
        value: ${{ jobs.report.outputs.helm_revision_after }}
      deploy_status:
        description: Deployment status
        value: ${{ jobs.report.outputs.deploy_status }}
      smoke_status:
        description: Smoke test status
        value: ${{ jobs.report.outputs.smoke_status }}
      rollback_status:
        description: Rollback status
        value: ${{ jobs.report.outputs.rollback_status }}

permissions:
  contents: read
  id-token: write

concurrency:
  group: reusable-gke-deploy-${{ inputs.environment_name }}-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment_name }}
    outputs:
      helm_revision_before: ${{ steps.revisions.outputs.helm_revision_before }}
      helm_revision_after: ${{ steps.revisions.outputs.helm_revision_after }}
      deploy_status: ${{ steps.deploy_status.outputs.deploy_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Validate required deploy secrets
        env:
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
          GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          test -n "${GCP_WIF_PROVIDER}" || (echo "Missing secret: GCP_WIF_PROVIDER" && exit 1)
          test -n "${GCP_SERVICE_ACCOUNT}" || (echo "Missing secret: GCP_SERVICE_ACCOUNT" && exit 1)
          test -n "${GKE_CLUSTER}" || (echo "Missing secret: GKE_CLUSTER" && exit 1)
          test -n "${GKE_LOCATION}" || (echo "Missing secret: GKE_LOCATION" && exit 1)
          test -n "${GCP_PROJECT_ID}" || (echo "Missing secret: GCP_PROJECT_ID" && exit 1)

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Capture Helm revision before deploy
        id: rev_before
        shell: bash
        run: |
          set -euo pipefail
          if helm status "${{ inputs.release_name }}" -n "${{ inputs.namespace }}" >/dev/null 2>&1; then
            BEFORE="$(helm history "${{ inputs.release_name }}" -n "${{ inputs.namespace }}" -o json | python -c 'import sys,json; h=json.load(sys.stdin); print(h[-1]["revision"] if h else "")')"
          else
            BEFORE=""
          fi
          echo "helm_revision_before=${BEFORE}" >> "$GITHUB_OUTPUT"

      - name: Deploy Helm chart
        id: deploy_chart
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          helm upgrade --install "${{ inputs.release_name }}" deploy/helm/a2a-mcp \
            --namespace "${{ inputs.namespace }}" \
            --create-namespace \
            --wait \
            --timeout 15m \
            -f deploy/helm/a2a-mcp/values.yaml \
            -f "${{ inputs.values_file }}" \
            --set images.mcp.repository="${{ inputs.mcp_image_repository }}" \
            --set images.mcp.tag="${{ inputs.mcp_image_tag }}" \
            --set images.orchestrator.repository="${{ inputs.orchestrator_image_repository }}" \
            --set images.orchestrator.tag="${{ inputs.orchestrator_image_tag }}"

      - name: Verify rollout
        id: rollout
        if: ${{ steps.deploy_chart.outcome == 'success' }}
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          kubectl rollout status deployment -n "${{ inputs.namespace }}" -l "app.kubernetes.io/instance=${{ inputs.release_name }},app.kubernetes.io/component=mcp" --timeout=600s
          kubectl rollout status deployment -n "${{ inputs.namespace }}" -l "app.kubernetes.io/instance=${{ inputs.release_name }},app.kubernetes.io/component=orchestrator" --timeout=600s

      - name: Capture Helm revision after deploy
        id: rev_after
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          if helm status "${{ inputs.release_name }}" -n "${{ inputs.namespace }}" >/dev/null 2>&1; then
            AFTER="$(helm history "${{ inputs.release_name }}" -n "${{ inputs.namespace }}" -o json | python -c 'import sys,json; h=json.load(sys.stdin); print(h[-1]["revision"] if h else "")')"
          else
            AFTER=""
          fi
          echo "helm_revision_after=${AFTER}" >> "$GITHUB_OUTPUT"

      - name: Publish deploy outputs
        id: revisions
        if: ${{ always() }}
        shell: bash
        run: |
          echo "helm_revision_before=${{ steps.rev_before.outputs.helm_revision_before }}" >> "$GITHUB_OUTPUT"
          echo "helm_revision_after=${{ steps.rev_after.outputs.helm_revision_after }}" >> "$GITHUB_OUTPUT"

      - name: Set deploy status
        id: deploy_status
        if: ${{ always() }}
        shell: bash
        run: |
          if [[ "${{ steps.deploy_chart.outcome }}" == "success" && "${{ steps.rollout.outcome }}" == "success" ]]; then
            echo "deploy_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "deploy_status=failed" >> "$GITHUB_OUTPUT"
          fi

  smoke:
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ needs.deploy.outputs.deploy_status == 'success' }}
    outputs:
      smoke_status: ${{ steps.smoke_status.outputs.smoke_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install smoke dependencies
        run: pip install requests

      - name: Validate smoke secrets
        if: ${{ inputs.smoke_enabled }}
        env:
          MCP_BASE_URL: ${{ secrets.MCP_BASE_URL }}
          ORCHESTRATOR_BASE_URL: ${{ secrets.ORCHESTRATOR_BASE_URL }}
          MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
        run: |
          set -euo pipefail
          test -n "${MCP_BASE_URL}" || (echo "Missing secret: MCP_BASE_URL" && exit 1)
          test -n "${ORCHESTRATOR_BASE_URL}" || (echo "Missing secret: ORCHESTRATOR_BASE_URL" && exit 1)
          test -n "${MCP_TOKEN}" || (echo "Missing secret: MCP_TOKEN" && exit 1)

      - name: Run smoke test
        id: run_smoke
        if: ${{ inputs.smoke_enabled }}
        continue-on-error: true
        env:
          MCP_BASE_URL: ${{ secrets.MCP_BASE_URL }}
          ORCHESTRATOR_BASE_URL: ${{ secrets.ORCHESTRATOR_BASE_URL }}
          SMOKE_AUTHORIZATION: ${{ secrets.MCP_TOKEN }}
        run: |
          python scripts/deploy/smoke_test.py

      - name: Set smoke status
        id: smoke_status
        if: ${{ always() }}
        shell: bash
        run: |
          if [[ "${{ inputs.smoke_enabled }}" != "true" ]]; then
            echo "smoke_status=skipped" >> "$GITHUB_OUTPUT"
          elif [[ "${{ steps.run_smoke.outcome }}" == "success" ]]; then
            echo "smoke_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "smoke_status=failed" >> "$GITHUB_OUTPUT"
          fi

  rollback:
    runs-on: ubuntu-latest
    needs: [deploy, smoke]
    if: ${{ always() && inputs.rollback_on_smoke_fail && needs.deploy.outputs.deploy_status == 'success' && needs.smoke.outputs.smoke_status == 'failed' }}
    outputs:
      rollback_status: ${{ steps.rollback_status.outputs.rollback_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Execute rollback
        id: do_rollback
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          PREV="${{ needs.deploy.outputs.helm_revision_before }}"
          if [[ -z "${PREV}" ]]; then
            echo "No previous revision available; rollback is not applicable"
            exit 0
          fi
          helm rollback "${{ inputs.release_name }}" "${PREV}" \
            -n "${{ inputs.namespace }}" \
            --wait \
            --timeout 15m
          kubectl rollout status deployment -n "${{ inputs.namespace }}" -l "app.kubernetes.io/instance=${{ inputs.release_name }},app.kubernetes.io/component=mcp" --timeout=600s
          kubectl rollout status deployment -n "${{ inputs.namespace }}" -l "app.kubernetes.io/instance=${{ inputs.release_name }},app.kubernetes.io/component=orchestrator" --timeout=600s

      - name: Set rollback status
        id: rollback_status
        if: ${{ always() }}
        shell: bash
        run: |
          PREV="${{ needs.deploy.outputs.helm_revision_before }}"
          if [[ -z "${PREV}" ]]; then
            echo "rollback_status=not_applicable" >> "$GITHUB_OUTPUT"
          elif [[ "${{ steps.do_rollback.outcome }}" == "success" ]]; then
            echo "rollback_status=rolled_back" >> "$GITHUB_OUTPUT"
          else
            echo "rollback_status=failed" >> "$GITHUB_OUTPUT"
          fi

  report:
    runs-on: ubuntu-latest
    needs: [deploy, smoke, rollback]
    if: ${{ always() }}
    outputs:
      helm_revision_before: ${{ steps.summary.outputs.helm_revision_before }}
      helm_revision_after: ${{ steps.summary.outputs.helm_revision_after }}
      deploy_status: ${{ steps.summary.outputs.deploy_status }}
      smoke_status: ${{ steps.summary.outputs.smoke_status }}
      rollback_status: ${{ steps.summary.outputs.rollback_status }}
    steps:
      - name: Summarize deployment status
        id: summary
        shell: bash
        run: |
          DEPLOY_STATUS="${{ needs.deploy.outputs.deploy_status }}"
          SMOKE_STATUS="${{ needs.smoke.outputs.smoke_status }}"
          ROLLBACK_STATUS="${{ needs.rollback.outputs.rollback_status }}"

          if [[ -z "${DEPLOY_STATUS}" ]]; then
            DEPLOY_STATUS="failed"
          fi
          if [[ -z "${SMOKE_STATUS}" ]]; then
            if [[ "${{ inputs.smoke_enabled }}" == "true" && "${DEPLOY_STATUS}" == "success" ]]; then
              SMOKE_STATUS="failed"
            else
              SMOKE_STATUS="skipped"
            fi
          fi
          if [[ -z "${ROLLBACK_STATUS}" ]]; then
            ROLLBACK_STATUS="not_triggered"
          fi

          mkdir -p artifacts
          cat > artifacts/deploy-summary.json <<EOF
          {
            "environment": "${{ inputs.environment_name }}",
            "namespace": "${{ inputs.namespace }}",
            "release_name": "${{ inputs.release_name }}",
            "deploy_status": "${DEPLOY_STATUS}",
            "smoke_status": "${SMOKE_STATUS}",
            "rollback_status": "${ROLLBACK_STATUS}",
            "helm_revision_before": "${{ needs.deploy.outputs.helm_revision_before }}",
            "helm_revision_after": "${{ needs.deploy.outputs.helm_revision_after }}"
          }
          EOF

          echo "helm_revision_before=${{ needs.deploy.outputs.helm_revision_before }}" >> "$GITHUB_OUTPUT"
          echo "helm_revision_after=${{ needs.deploy.outputs.helm_revision_after }}" >> "$GITHUB_OUTPUT"
          echo "deploy_status=${DEPLOY_STATUS}" >> "$GITHUB_OUTPUT"
          echo "smoke_status=${SMOKE_STATUS}" >> "$GITHUB_OUTPUT"
          echo "rollback_status=${ROLLBACK_STATUS}" >> "$GITHUB_OUTPUT"

      - name: Upload deployment summary
        uses: actions/upload-artifact@v4
        with:
          name: deploy-summary-${{ inputs.environment_name }}-${{ github.run_id }}
          path: artifacts/deploy-summary.json
