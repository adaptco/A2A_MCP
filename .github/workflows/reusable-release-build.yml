name: Reusable Release Build

on:
  workflow_call:
    inputs:
      image_tag_override:
        description: Optional image tag override
        required: false
        default: ""
        type: string
      run_security_scan:
        description: Enable signing and verification steps
        required: false
        default: true
        type: boolean
    outputs:
      version_tag:
        description: Resolved release image tag
        value: ${{ jobs.build-and-publish.outputs.version_tag }}
      sha_tag:
        description: Commit SHA image tag
        value: ${{ jobs.build-and-publish.outputs.sha_tag }}
      mcp_image_ref:
        description: MCP image reference with digest
        value: ${{ jobs.build-and-publish.outputs.mcp_image_ref }}
      orchestrator_image_ref:
        description: Orchestrator image reference with digest
        value: ${{ jobs.build-and-publish.outputs.orchestrator_image_ref }}
      chart_artifact_name:
        description: Helm chart artifact name
        value: ${{ jobs.helm-lint-template-package.outputs.chart_artifact_name }}
      sbom_artifact_name:
        description: SBOM artifact name
        value: ${{ jobs.generate-sbom.outputs.sbom_artifact_name }}

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  validate-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run validation tests
        run: |
          python -m pytest -q tests/test_mcp_agents.py tests/test_worldline_ingestion.py

  build-and-publish:
    runs-on: ubuntu-latest
    needs: validate-tests
    outputs:
      version_tag: ${{ steps.meta.outputs.version_tag }}
      sha_tag: ${{ steps.meta.outputs.sha_tag }}
      mcp_image_ref: ${{ steps.image_refs.outputs.mcp_image_ref }}
      orchestrator_image_ref: ${{ steps.image_refs.outputs.orchestrator_image_ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tags
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          SHA_TAG="sha-${GITHUB_SHA::12}"
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION_TAG="${{ github.event.release.tag_name }}"
          elif [[ -n "${{ inputs.image_tag_override }}" ]]; then
            VERSION_TAG="${{ inputs.image_tag_override }}"
          else
            VERSION_TAG="${SHA_TAG}"
          fi
          echo "version_tag=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push MCP image
        id: build_mcp
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/docker/Dockerfile.mcp
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/a2a-mcp-mcp:${{ steps.meta.outputs.version_tag }}
            ghcr.io/${{ github.repository_owner }}/a2a-mcp-mcp:${{ steps.meta.outputs.sha_tag }}

      - name: Build and push orchestrator image
        id: build_orchestrator
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/docker/Dockerfile.orchestrator
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/a2a-mcp-orchestrator:${{ steps.meta.outputs.version_tag }}
            ghcr.io/${{ github.repository_owner }}/a2a-mcp-orchestrator:${{ steps.meta.outputs.sha_tag }}

      - name: Publish image references
        id: image_refs
        shell: bash
        run: |
          set -euo pipefail
          echo "mcp_image_ref=ghcr.io/${{ github.repository_owner }}/a2a-mcp-mcp@${{ steps.build_mcp.outputs.digest }}" >> "$GITHUB_OUTPUT"
          echo "orchestrator_image_ref=ghcr.io/${{ github.repository_owner }}/a2a-mcp-orchestrator@${{ steps.build_orchestrator.outputs.digest }}" >> "$GITHUB_OUTPUT"

  generate-sbom:
    runs-on: ubuntu-latest
    needs: build-and-publish
    outputs:
      sbom_artifact_name: ${{ steps.meta.outputs.sbom_artifact_name }}
    steps:
      - name: Set artifact metadata
        id: meta
        shell: bash
        run: |
          echo "sbom_artifact_name=release-sbom-${{ needs.build-and-publish.outputs.version_tag }}" >> "$GITHUB_OUTPUT"

      - name: Generate MCP SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ needs.build-and-publish.outputs.mcp_image_ref }}
          format: spdx-json
          output-file: sbom-mcp.spdx.json

      - name: Generate orchestrator SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ needs.build-and-publish.outputs.orchestrator_image_ref }}
          format: spdx-json
          output-file: sbom-orchestrator.spdx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.sbom_artifact_name }}
          path: |
            sbom-mcp.spdx.json
            sbom-orchestrator.spdx.json

  sign-and-verify-images:
    runs-on: ubuntu-latest
    if: ${{ inputs.run_security_scan }}
    needs: build-and-publish
    steps:
      - name: Install cosign
        uses: sigstore/cosign-installer@v3.7.0

      - name: Sign images (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign sign --yes ${{ needs.build-and-publish.outputs.mcp_image_ref }}
          cosign sign --yes ${{ needs.build-and-publish.outputs.orchestrator_image_ref }}

      - name: Verify signatures
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}.*" \
            ${{ needs.build-and-publish.outputs.mcp_image_ref }}
          cosign verify \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}.*" \
            ${{ needs.build-and-publish.outputs.orchestrator_image_ref }}

  helm-lint-template-package:
    runs-on: ubuntu-latest
    needs: build-and-publish
    outputs:
      chart_artifact_name: ${{ steps.meta.outputs.chart_artifact_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Lint and template chart
        run: |
          set -euo pipefail
          helm lint deploy/helm/a2a-mcp -f deploy/helm/a2a-mcp/values.yaml -f deploy/helm/a2a-mcp/values-staging.yaml
          helm lint deploy/helm/a2a-mcp -f deploy/helm/a2a-mcp/values.yaml -f deploy/helm/a2a-mcp/values-prod.yaml
          helm template a2a-mcp-staging deploy/helm/a2a-mcp -f deploy/helm/a2a-mcp/values.yaml -f deploy/helm/a2a-mcp/values-staging.yaml > staging-rendered.yaml
          helm template a2a-mcp-prod deploy/helm/a2a-mcp -f deploy/helm/a2a-mcp/values.yaml -f deploy/helm/a2a-mcp/values-prod.yaml > prod-rendered.yaml

      - name: Package chart
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          helm package deploy/helm/a2a-mcp --destination dist
          sha256sum dist/*.tgz > dist/chart-checksums.txt
          echo "chart_artifact_name=release-chart-${{ needs.build-and-publish.outputs.version_tag }}" >> "$GITHUB_OUTPUT"

      - name: Upload chart artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.chart_artifact_name }}
          path: |
            dist/*.tgz
            dist/chart-checksums.txt
            staging-rendered.yaml
            prod-rendered.yaml

  publish-build-artifacts:
    runs-on: ubuntu-latest
    needs:
      - build-and-publish
      - generate-sbom
      - helm-lint-template-package
      - sign-and-verify-images
    if: ${{ always() }}
    steps:
      - name: Build metadata summary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          cat > artifacts/release-build-metadata.json <<EOF
          {
            "version_tag": "${{ needs.build-and-publish.outputs.version_tag }}",
            "sha_tag": "${{ needs.build-and-publish.outputs.sha_tag }}",
            "mcp_image_ref": "${{ needs.build-and-publish.outputs.mcp_image_ref }}",
            "orchestrator_image_ref": "${{ needs.build-and-publish.outputs.orchestrator_image_ref }}",
            "chart_artifact_name": "${{ needs.helm-lint-template-package.outputs.chart_artifact_name }}",
            "sbom_artifact_name": "${{ needs.generate-sbom.outputs.sbom_artifact_name }}",
            "security_scan_enabled": ${{ inputs.run_security_scan }}
          }
          EOF

      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: release-build-metadata-${{ needs.build-and-publish.outputs.version_tag }}
          path: artifacts/release-build-metadata.json
