{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://adaptco.dev/schemas/manifold_action_language.schema.json",
  "title": "Manifold Engine Language (MEL-1)",
  "description": "Concrete schema for manifold decision inputs and generated actions.",
  "type": "object",
  "required": [
    "schema_version",
    "language",
    "records"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0"
    },
    "language": {
      "type": "string",
      "const": "MEL-1"
    },
    "records": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/record"
      }
    }
  },
  "additionalProperties": false,
  "$defs": {
    "score01": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0
    },
    "constraint": {
      "type": "object",
      "required": ["id", "kind", "value"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "minLength": 1 },
        "value": { "type": "string" }
      },
      "additionalProperties": false
    },
    "task": {
      "type": "object",
      "required": ["task_id", "title", "instruction"],
      "properties": {
        "task_id": { "type": "string", "minLength": 1 },
        "title": { "type": "string", "minLength": 1 },
        "instruction": { "type": "string", "minLength": 1 },
        "requester": { "type": "string" },
        "created_at": { "type": "string", "format": "date-time" },
        "dependencies": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true
        },
        "constraints": {
          "type": "array",
          "items": { "$ref": "#/$defs/constraint" }
        }
      },
      "additionalProperties": false
    },
    "decision_axes": {
      "type": "object",
      "required": [
        "impact",
        "urgency",
        "feasibility",
        "verification_confidence",
        "coordination_cost",
        "risk_score"
      ],
      "properties": {
        "impact": { "$ref": "#/$defs/score01" },
        "urgency": { "$ref": "#/$defs/score01" },
        "feasibility": { "$ref": "#/$defs/score01" },
        "verification_confidence": { "$ref": "#/$defs/score01" },
        "coordination_cost": { "$ref": "#/$defs/score01" },
        "risk_score": { "$ref": "#/$defs/score01" }
      },
      "additionalProperties": false
    },
    "weights": {
      "type": "object",
      "required": [
        "impact",
        "urgency",
        "feasibility",
        "verification_confidence",
        "coordination_cost",
        "risk_score"
      ],
      "properties": {
        "impact": { "type": "number", "minimum": 0.0 },
        "urgency": { "type": "number", "minimum": 0.0 },
        "feasibility": { "type": "number", "minimum": 0.0 },
        "verification_confidence": { "type": "number", "minimum": 0.0 },
        "coordination_cost": { "type": "number", "minimum": 0.0 },
        "risk_score": { "type": "number", "minimum": 0.0 }
      },
      "additionalProperties": false
    },
    "candidate_action": {
      "type": "object",
      "required": [
        "action_id",
        "instruction",
        "owner_agent",
        "acceptance_checks",
        "utility"
      ],
      "properties": {
        "action_id": { "type": "string", "minLength": 1 },
        "instruction": { "type": "string", "minLength": 1 },
        "owner_agent": { "type": "string", "minLength": 1 },
        "preconditions": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "acceptance_checks": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        },
        "utility": { "type": "number" },
        "metadata": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "decision_result": {
      "type": "object",
      "required": [
        "formula",
        "weights",
        "top_k",
        "selected_actions"
      ],
      "properties": {
        "formula": {
          "type": "string",
          "const": "U = wi*impact + wu*urgency + wf*feasibility + wv*verification_confidence - wc*coordination_cost - wr*risk_score"
        },
        "weights": { "$ref": "#/$defs/weights" },
        "top_k": { "type": "integer", "minimum": 1, "maximum": 20 },
        "selected_actions": {
          "type": "array",
          "items": { "$ref": "#/$defs/candidate_action" }
        }
      },
      "additionalProperties": false
    },
    "source_trace": {
      "type": "object",
      "properties": {
        "source_system": { "type": "string" },
        "source_document_id": { "type": "string" },
        "source_xpath": { "type": "string" }
      },
      "additionalProperties": false
    },
    "record": {
      "type": "object",
      "required": [
        "record_type",
        "task",
        "decision_axes"
      ],
      "properties": {
        "record_type": {
          "type": "string",
          "const": "manifold_input"
        },
        "task": { "$ref": "#/$defs/task" },
        "decision_axes": { "$ref": "#/$defs/decision_axes" },
        "context": {
          "type": "object",
          "additionalProperties": true
        },
        "source_trace": { "$ref": "#/$defs/source_trace" },
        "decision_result": { "$ref": "#/$defs/decision_result" }
      },
      "additionalProperties": false
    }
  }
}
