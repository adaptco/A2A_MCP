{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Mission Meta Directive v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema",
    "version",
    "mission",
    "state_machine",
    "protocol",
    "integrity"
  ],
  "properties": {
    "schema": {
      "const": "mission.meta.directive.v1"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "mission": {
      "$ref": "#/$defs/mission"
    },
    "state_machine": {
      "$ref": "#/$defs/state_machine"
    },
    "protocol": {
      "$ref": "#/$defs/protocol"
    },
    "integrity": {
      "$ref": "#/$defs/integrity"
    },
    "notes": {
      "type": "array",
      "items": {
        "type": "string"
      }
    }
  },
  "$defs": {
    "mission": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mission_id",
        "codename",
        "cohort",
        "objective",
        "timeline",
        "bundle",
        "communications",
        "success_criteria"
      ],
      "properties": {
        "mission_id": {
          "type": "string",
          "pattern": "^mission-[a-z0-9-]+$"
        },
        "codename": {
          "type": "string",
          "minLength": 1
        },
        "cohort": {
          "type": "string",
          "pattern": "^cohort-[a-z0-9-]+$"
        },
        "objective": {
          "type": "string",
          "minLength": 1
        },
        "timeline": {
          "$ref": "#/$defs/timeline"
        },
        "bundle": {
          "$ref": "#/$defs/bundle"
        },
        "communications": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/communication_channel"
          }
        },
        "success_criteria": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/success_criterion"
          }
        },
        "dependencies": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/dependency"
          }
        }
      }
    },
    "timeline": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "window",
        "phases",
        "current_phase"
      ],
      "properties": {
        "window": {
          "type": "object",
          "additionalProperties": false,
          "required": ["start", "end"],
          "properties": {
            "start": {"$ref": "#/$defs/timestamp"},
            "end": {"$ref": "#/$defs/timestamp"}
          }
        },
        "phases": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/phase"
          }
        },
        "current_phase": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "phase": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "entry_criteria", "exit_criteria"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "entry_criteria": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/check"
          }
        },
        "exit_criteria": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/check"
          }
        },
        "duration_minutes": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "check": {
      "type": "object",
      "additionalProperties": false,
      "required": ["description"],
      "properties": {
        "description": {
          "type": "string",
          "minLength": 1
        },
        "source": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "bundle": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "version", "hash", "artifact"],
      "properties": {
        "name": {"type": "string", "minLength": 1},
        "version": {"type": "string", "minLength": 1},
        "hash": {
          "type": "string",
          "pattern": "^sha256:[0-9a-f]{64}$"
        },
        "artifact": {
          "type": "string",
          "minLength": 1
        },
        "source_repo": {
          "type": "string",
          "format": "uri"
        }
      }
    },
    "communication_channel": {
      "type": "object",
      "additionalProperties": false,
      "required": ["channel", "medium", "address"],
      "properties": {
        "channel": {"type": "string", "minLength": 1},
        "medium": {"type": "string", "enum": ["matrix", "slack", "email", "radio"]},
        "address": {"type": "string", "minLength": 1},
        "purpose": {"type": "string"}
      }
    },
    "success_criterion": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "description", "metric"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^sc-[a-z0-9-]+$"
        },
        "description": {"type": "string", "minLength": 1},
        "metric": {"type": "string", "minLength": 1},
        "target": {"type": "string"}
      }
    },
    "dependency": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "status"],
      "properties": {
        "id": {"type": "string", "minLength": 1},
        "status": {"type": "string", "enum": ["ready", "degraded", "blocked"]},
        "notes": {"type": "string"}
      }
    },
    "state_machine": {
      "type": "object",
      "additionalProperties": false,
      "required": ["initial_state", "states", "transitions"],
      "properties": {
        "initial_state": {
          "type": "string",
          "minLength": 1
        },
        "states": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/state"
          }
        },
        "transitions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/transition"
          }
        },
        "state": {
          "type": "string",
          "minLength": 1
        },
        "previous_state": {
          "type": ["string", "null"]
        },
        "transition_cause": {
          "type": "string"
        }
      }
    },
    "state": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "description",
        "entry_checks",
        "exit_conditions",
        "fail_closed_actions"
      ],
      "properties": {
        "name": {"type": "string", "minLength": 1},
        "description": {"type": "string", "minLength": 1},
        "entry_checks": {
          "type": "array",
          "minItems": 1,
          "items": {"$ref": "#/$defs/check"}
        },
        "exit_conditions": {
          "type": "array",
          "minItems": 1,
          "items": {"$ref": "#/$defs/check"}
        },
        "fail_closed_actions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/action"
          }
        },
        "allowed_transitions": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "action": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {"type": "string", "minLength": 1},
        "parameters": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "transition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["from", "to", "trigger", "conditions", "on_success", "on_failure"],
      "properties": {
        "from": {"type": "string", "minLength": 1},
        "to": {"type": "string", "minLength": 1},
        "trigger": {"type": "string", "minLength": 1},
        "conditions": {
          "type": "array",
          "items": {"$ref": "#/$defs/check"}
        },
        "on_success": {
          "type": "array",
          "items": {"$ref": "#/$defs/action"}
        },
        "on_failure": {
          "type": "array",
          "items": {"$ref": "#/$defs/action"}
        },
        "guard": {
          "type": "string"
        }
      }
    },
    "protocol": {
      "type": "object",
      "additionalProperties": false,
      "required": ["retargeting", "rollback", "reporting"],
      "properties": {
        "retargeting": {
          "$ref": "#/$defs/retargeting"
        },
        "rollback": {
          "$ref": "#/$defs/rollback"
        },
        "reporting": {
          "$ref": "#/$defs/reporting"
        }
      }
    },
    "retargeting": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allowed", "constraints", "required_signoffs"],
      "properties": {
        "allowed": {"type": "boolean"},
        "constraints": {
          "type": "array",
          "items": {"type": "string"}
        },
        "required_signoffs": {
          "type": "array",
          "minItems": 1,
          "items": {"type": "string"}
        },
        "fallback_state": {
          "type": "string"
        }
      }
    },
    "rollback": {
      "type": "object",
      "additionalProperties": false,
      "required": ["trigger_conditions", "actions", "verification"],
      "properties": {
        "trigger_conditions": {
          "type": "array",
          "items": {"$ref": "#/$defs/check"}
        },
        "actions": {
          "type": "array",
          "items": {"$ref": "#/$defs/action"}
        },
        "verification": {
          "type": "array",
          "items": {"$ref": "#/$defs/check"}
        }
      }
    },
    "reporting": {
      "type": "object",
      "additionalProperties": false,
      "required": ["cadence", "channels"],
      "properties": {
        "cadence": {"type": "string", "minLength": 1},
        "channels": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "integrity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["hash_algorithm", "content_hash"],
      "properties": {
        "hash_algorithm": {
          "type": "string",
          "enum": ["sha256"]
        },
        "content_hash": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "signed_at": {
          "$ref": "#/$defs/timestamp"
        },
        "signed_by": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/signatory"
          }
        }
      }
    },
    "signatory": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "role"],
      "properties": {
        "name": {"type": "string", "minLength": 1},
        "role": {"type": "string", "minLength": 1},
        "signature": {"type": "string"}
      }
    },
    "timestamp": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
    }
  }
}
