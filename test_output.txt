<<<<<<< HEAD
ï»¿============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\eqhsp\.gemini\antigravity\scratch\A2A_MCP
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 46 items

tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_returns_artifacts PASSED [  2%]
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_records_in_world_model PASSED [  4%]
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_persists_all_artifacts PASSED [  6%]
tests/test_dot_product.py::TestDotProduct::test_dot_product_basic PASSED [  8%]
tests/test_dot_product.py::TestDotProduct::test_dot_product_zero_vector PASSED [ 10%]
tests/test_dot_product.py::TestDotProduct::test_dot_product_length_mismatch_raises PASSED [ 13%]
tests/test_dot_product.py::TestDotProduct::test_magnitude PASSED         [ 15%]
tests/test_dot_product.py::TestDotProduct::test_magnitude_zero PASSED    [ 17%]
tests/test_dot_product.py::TestCosineSimilarity::test_identical_vectors PASSED [ 19%]
tests/test_dot_product.py::TestCosineSimilarity::test_orthogonal_vectors PASSED [ 21%]
tests/test_dot_product.py::TestCosineSimilarity::test_opposite_vectors PASSED [ 23%]
tests/test_dot_product.py::TestCosineSimilarity::test_zero_vector_returns_zero PASSED [ 26%]
tests/test_dot_product.py::TestRankCandidates::test_ranking_order PASSED [ 28%]
tests/test_dot_product.py::TestRankCandidates::test_ranking_returns_all_candidates PASSED [ 30%]
tests/test_healing_loop.py::test_healing_loop_convergence PASSED         [ 32%]
tests/test_intent_engine.py::test_pinn_deterministic_embedding_is_stable PASSED [ 34%]
tests/test_intent_engine.py::test_intent_engine_executes_plan PASSED     [ 36%]
tests/test_managing_agent.py::TestManagingAgent::test_categorize_produces_plan PASSED [ 39%]
tests/test_managing_agent.py::TestManagingAgent::test_categorize_persists_artifact PASSED [ 41%]
tests/test_managing_agent.py::TestManagingAgent::test_categorize_fallback_single_action PASSED [ 43%]
tests/test_managing_agent.py::TestManagingAgent::test_parse_actions_handles_varied_formats PASSED [ 45%]
tests/test_orchestration_agent.py::TestOrchestrationAgent::test_build_blueprint_returns_project_plan PASSED [ 47%]
tests/test_orchestration_agent.py::TestOrchestrationAgent::test_blueprint_creates_actions_per_pipeline_stage PASSED [ 50%]
tests/test_orchestration_agent.py::TestOrchestrationAgent::test_blueprint_action_metadata_contains_delegation PASSED [ 52%]
tests/test_orchestration_agent.py::TestOrchestrationAgent::test_blueprint_persists_artifact PASSED [ 54%]
tests/test_plan_state_persistence.py::test_plan_state_save_load_roundtrip PASSED [ 56%]
tests/test_stateflow.py::test_happy_path PASSED                          [ 58%]
tests/test_stateflow.py::test_retry_limit_exceeded FAILED                [ 60%]
tests/test_stateflow.py::test_override_forward_only PASSED               [ 63%]
tests/test_storage.py::test_artifact_persistence_lifecycle FAILED        [ 65%]
tests/test_system_prompt.py::TestSystemPromptSchema::test_minimal_valid_prompt PASSED [ 67%]
tests/test_system_prompt.py::TestSystemPromptSchema::test_custom_embedding_dim PASSED [ 69%]
tests/test_system_prompt.py::TestSystemPromptSchema::test_model_context_defaults_to_empty PASSED [ 71%]
tests/test_system_prompt.py::TestSystemPromptSchema::test_serialisation_round_trip PASSED [ 73%]
tests/test_system_prompt.py::TestSystemPromptSchema::test_missing_required_fields_raises PASSED [ 76%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_non_empty_system_text[prompt0] PASSED [ 78%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_non_empty_system_text[prompt1] PASSED [ 80%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_non_empty_system_text[prompt2] PASSED [ 82%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_non_empty_system_text[prompt3] PASSED [ 84%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_non_empty_system_text[prompt4] PASSED [ 86%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_valid_role[prompt0] PASSED [ 89%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_valid_role[prompt1] PASSED [ 91%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_valid_role[prompt2] PASSED [ 93%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_valid_role[prompt3] PASSED [ 95%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_prebuilt_has_valid_role[prompt4] PASSED [ 97%]
tests/test_system_prompt.py::TestPreBuiltPrompts::test_all_prompt_ids_unique PASSED [100%]

================================== FAILURES ===================================
__________________________ test_retry_limit_exceeded __________________________

    def test_retry_limit_exceeded():
        sm = StateMachine(max_retries=2)
        sm.trigger("OBJECTIVE_INGRESS")
        sm.trigger("RUN_DISPATCHED")
        sm.trigger("EXECUTION_COMPLETE")
    
        # policy that requests partial verdict (retry) by raising PartialVerdict
        def policy_partial():
            raise PartialVerdict()
    
        # first partial -> RETRY
        sm.evaluate_apply_policy(policy_partial)
        assert sm.current_state() == State.RETRY
        # dispatch retry
        sm.trigger("RETRY_DISPATCHED")
        assert sm.current_state() == State.EXECUTING
        # execution completes again
        sm.trigger("EXECUTION_COMPLETE")
        # second partial -> now max_retries is 2 => should lead to TERMINATED_FAIL
        sm.evaluate_apply_policy(policy_partial)
>       assert sm.current_state() == State.TERMINATED_FAIL
E       AssertionError: assert <State.RETRY: 'RETRY'> == <State.TERMIN...MINATED_FAIL'>
E         
E         - TERMINATED_FAIL
E         + RETRY

tests\test_stateflow.py:41: AssertionError
_____________________ test_artifact_persistence_lifecycle _____________________

    def test_artifact_persistence_lifecycle():
        """
        Validates the 'Schematic Rigor' directive by testing
        the full Save -> Retrieve cycle.
        """
        db = DBManager()
        test_id = str(uuid.uuid4())
    
        # 1. Setup Mock Artifact
        artifact = MCPArtifact(
            artifact_id=test_id,
            parent_artifact_id="root-node",
            agent_name="TestAgent",
            version="1.0.0",
            type="unit_test_artifact",
            content='{"status": "verified"}'
        )
    
        # 2. Test Save (Persistence Directive)
        db.save_artifact(artifact)
    
        # 3. Test Retrieval (Traceability Directive)
        retrieved = db.get_artifact(test_id)
    
        assert retrieved is not None
>       assert retrieved.agent_name == "TestAgent"
E       AssertionError: assert 'UnknownAgent' == 'TestAgent'
E         
E         - TestAgent
E         + UnknownAgent

tests\test_storage.py:31: AssertionError
============================== warnings summary ===============================
schemas\database.py:6
  C:\Users\eqhsp\.gemini\antigravity\scratch\A2A_MCP\schemas\database.py:6: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

agents\tester.py:6
  C:\Users\eqhsp\.gemini\antigravity\scratch\A2A_MCP\agents\tester.py:6: PytestCollectionWarning: cannot collect test class 'TestReport' because it has a __init__ constructor (from: tests/test_intent_engine.py)
    class TestReport(BaseModel):

tests/test_architecture_agent.py: 6 warnings
tests/test_managing_agent.py: 3 warnings
tests/test_orchestration_agent.py: 4 warnings
tests/test_storage.py: 1 warning
  C:\Users\eqhsp\.gemini\antigravity\scratch\A2A_MCP\schemas\agent_artifacts.py:12: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    timestamp: str = Field(default_factory=lambda: datetime.utcnow().isoformat())

tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_returns_artifacts
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_returns_artifacts
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_records_in_world_model
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_records_in_world_model
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_persists_all_artifacts
tests/test_architecture_agent.py::TestArchitectureAgent::test_map_system_persists_all_artifacts
  C:\Users\eqhsp\AppData\Roaming\Python\Python313\site-packages\pydantic\main.py:250: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

tests/test_plan_state_persistence.py::test_plan_state_save_load_roundtrip
tests/test_plan_state_persistence.py::test_plan_state_save_load_roundtrip
tests/test_plan_state_persistence.py::test_plan_state_save_load_roundtrip
tests/test_plan_state_persistence.py::test_plan_state_save_load_roundtrip
tests/test_plan_state_persistence.py::test_plan_state_save_load_roundtrip
tests/test_storage.py::test_artifact_persistence_lifecycle
  C:\Users\eqhsp\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_stateflow.py::test_retry_limit_exceeded - AssertionError: a...
FAILED tests/test_storage.py::test_artifact_persistence_lifecycle - Assertion...
================== 2 failed, 44 passed, 28 warnings in 7.18s ==================
=======
============================= test session starts =============================
collecting ... collected 5 items

tests/test_full_pipeline.py::TestFullPipeline::test_happy_path_all_pass PASSED [ 20%]
tests/test_full_pipeline.py::TestFullPipeline::test_self_healing_fail_then_pass PASSED [ 40%]
tests/test_full_pipeline.py::TestFullPipeline::test_all_fail_reports_failure PASSED [ 60%]
tests/test_full_pipeline.py::TestFullPipeline::test_artifact_counts PASSED [ 80%]
tests/test_full_pipeline.py::TestFullPipeline::test_legacy_execute_plan_still_works PASSED [100%]

============================== warnings summary ===============================
schemas\database.py:6
  C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\schemas\database.py:6: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

agents\tester.py:6
  C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\agents\tester.py:6: PytestCollectionWarning: cannot collect test class 'TestReport' because it has a __init__ constructor (from: tests/test_full_pipeline.py)
    class TestReport(BaseModel):

tests/test_full_pipeline.py: 81 warnings
  C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\schemas\agent_artifacts.py:12: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    timestamp: str = Field(default_factory=lambda: datetime.utcnow().isoformat())

tests/test_full_pipeline.py: 28 warnings
  C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\.venv\Lib\site-packages\pydantic\main.py:250: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
======================= 5 passed, 111 warnings in 0.91s =======================
>>>>>>> 117e2e444ff3d500482857ebf717156179fbdeed
